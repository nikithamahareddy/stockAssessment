<!DOCTYPE html>
<html>

<head>
    <title>Page Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            padding: 0px;
            margin: 0px;
        }

        .wrapper {
            padding: 20px;
            background: #514e4e1a;
        }

        .wrapone {
            background: #23243f;
            padding: 20px;
        }

        #searchbyname {
            padding: 8px 8px;
            min-width: 90%;
            margin: 10px auto;
            border-radius: 10px
        }

        .header {
            color: white;
            text-align: center;
            padding: 6px;
            font-family: cursive;
        }

        #stockform {
            margin: 10px;
        }

        #csvfile {
            color: white;
        }

        #submit {
            background: #ededed;
            color: black;
        }

        #stockheaders {
            font-size: 18px;
        }

        .pagination-disable {
            pointer-events: none;
            background-color: gray;
            color: white
        }
    </style>
</head>

<body>
    <div class="container wrapper">
        <div class="row wrapone">
            <div class="col-md-4">
                <input type="text" id="searchbyname" onchange="searchData()" placeholder="Search by name">
            </div>
            <div class="col-md-4 header">
                <h2>Stock Records</h2>
            </div>
            <div class="col-md-4">
                <form id="stockform" class="row">
                    <input type="file" id="csvfile" accept=".csv" class="col-md-9">
                    <input type="submit" id="submit" class="col-md-3 btn">
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <table class="table table-striped ">
                    <thead id="stockheaders">
                        <tr>
                            <th>Name</th>
                            <th>Batch</th>
                            <th>Stock</th>
                            <th>Deal</th>
                            <th>Free</th>
                            <th>Mrp</th>
                            <th>Rate</th>
                            <th>Exp Date</th>
                        </tr>
                    </thead>
                    <tbody id="stockrows">

                    </tbody>
                    <tfoot class="">
                        <tr>
                            <td colspan="8">
                                <ul class="pagination">
                                    <li class="page-item"><a class="page-link " href="#" id="finalPreviousPage"
                                            onclick="finalPreviousPage()">Previous</a>
                                    </li>
                                    <li class="page-item"><a class="page-link" href="#" id="previousPage"
                                            onclick="previousPage()">prev</a></li>
                                    <li class="page-item active"><a class="page-link" href="#" id="currentPage">1</a>
                                    </li>
                                    <li class="page-item"><a class="page-link" href="#" id="nextPage"
                                            onclick="nextPage()">></a></li>
                                    <li class="page-item"><a class="page-link" href="#" id="finalNextPage"
                                            onclick="finalNextPage()">>></a></li>
                                </ul>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    </div>

    <script>
        var stockData = [];
        var pageSize = 10;
        var pageNumber = 1;
        var stockform = document.getElementById("stockform");
        var csvfile = document.getElementById("csvfile");
        stockform.addEventListener("submit", function (e) {
            e.preventDefault();
            console.log("form submitted");
            const csvData = csvfile.files[0];
            console.log(csvData);

            var fileReader = new FileReader();
            fileReader.onload = function (e) {
                console.log(e.target);
                var data = e.target.result;
                csvDataToArray(data);
            }
            fileReader.readAsText(csvData)
        })
        function csvDataToArray(data) {
            const csvArray = data.split("\r\n")
            var headers = csvArray.slice(0, 1)[0].split(",");
            var rows = csvArray.slice(1);
            console.log(headers);
            var tableData = [];
            rows.forEach(function (data, index) {
                var rowValue = data.split(",");
                var obj = {};
                for (let i = 0; i <= headers.length - 1; i++) {
                    obj[headers[i]] = rowValue[i];
                }
                tableData.push(obj)
            })
            console.log(tableData);
            stockData = groupByName(tableData, "name");
            displayTable(stockData);

        }

        function displayTable(tableData) {
            var tablerow = "";
            pagination(tableData, pageSize, pageNumber).forEach(function (data, index) {
                var rowstring = `<tr>
                    <td>${data.name}</td>
                    <td>${data.batch}</td>
                    <td>${data.stock}</td>
                    <td>${data.deal}</td>
                    <td>${data.free}</td>
                    <td>${data.mrp}</td>
                    <td>${data.rate}</td>
                    <td>${data.exp}</td>
                </tr>`
                tablerow = tablerow.concat(rowstring);
            })
            paginationBar();
            document.getElementById("stockrows").innerHTML = tablerow;
            document.getElementById("currentPage").innerText = pageNumber;
        }
        function searchData() {
            var searchValue = document.getElementById("searchbyname").value;
            console.log(searchValue);
            var filteredData = stockData.filter(function (value) {
                return value.name.toLowerCase().includes(searchValue.toLowerCase());
            });

            console.log(filteredData)
            displayTable(filteredData);
        }
        function groupByName(array, groupBy) {
            var groupByObj = array.reduce(function (initial, currentObj) {
                const key = currentObj[groupBy];
                if (!initial[key]) {
                    initial[key] = [];
                }
                initial[key].push(currentObj);
                return initial;
            }, {})
            var finalData = [];
            for (let i in groupByObj) {
                var data = groupByObj[i].reduce(function (initial, current) {
                    initial.batch = "All";
                    initial.stock = Number(initial.stock) + Number(current.stock);
                    initial.deal = Math.min(initial.deal, current.deal);
                    initial.free = Math.min(initial.free, current.free);
                    initial.mrp = Math.max(initial.mrp, current.mrp);
                    initial.rate = Math.max(initial.rate, current.rate);
                    return initial;
                })
                finalData.push(data);
            }
            return finalData;
        }
        function pagination(array, pageSize, pageNumber) {
            return array.slice((pageNumber - 1) * pageSize, pageNumber * pageSize)
        }
        function nextPage() {
            pageNumber++;
            displayTable(stockData);
        }
        function previousPage() {
            pageNumber--;
            displayTable(stockData);
        }
        function finalPreviousPage() {

            console.log("hi");
            pageNumber = 1;
            displayTable(stockData);
        }
        function finalNextPage() {
            pageNumber = Math.round((stockData.length) / pageSize);
            displayTable(stockData);
        }
        function paginationBar() {
            var finalNextPage = document.getElementById("finalNextPage");
            var finalPreviousPage = document.getElementById("finalPreviousPage");
            var previousPage = document.getElementById("previousPage");
            var nextPage = document.getElementById("nextPage");
            if (pageNumber <= 1) {
                previousPage.classList.add("pagination-disable")
            }
            else {
                previousPage.classList.remove("pagination-disable")
            }
            if (pageNumber <= 2) {
                finalPreviousPage.classList.add("pagination-disable")
            }
            else {
                finalPreviousPage.classList.remove("pagination-disable")
            }
            if (stockData.length / pageSize < 2 || Math.round(stockData.length / pageSize) == pageNumber) {
                nextPage.classList.add("pagination-disable");
            }
            else {
                nextPage.classList.remove("pagination-disable")
            }
            if (stockData.length / pageSize < 3 || Math.round(stockData.length / pageSize) == pageNumber) {
                finalNextPage.classList.add("pagination-disable")
            }
            else {
                finalNextPage.classList.remove("pagination-disable")
            }
        }
    </script>
</body>

</html>